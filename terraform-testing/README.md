

https://www.hashicorp.com/blog/testing-hashicorp-terraform

https://www.hashicorp.com/resources/test-driven-development-tdd-for-infrastructure

https://www.conftest.dev/

**** unit or contract (state) testing ***

# why testing
    When you’ve updated some HashiCorp Terraform configuration or a new version of a module, you want to catch errors quickly before you apply any changes to production infrastructure.

Ideally, your infrastructure testing strategy should align with the test pyramid, which groups tests by type, scope, and granularity. 
The higher up the pyramid you go, the fewer tests you should have for that level of the pyramid. 

# Unit Tests
    * answer the question, "Does my configuration or plan contain the correct metadata?"
    * Traditionally, unit tests should run independently, without external resources or API calls.
    * You can use terraform fmt -check and terraform validate as rudimentary unit tests. 
    * state testing
    * Additionally, unit tests can validate:
        Number of resources or attributes generated by for_each or count
        Values generated by for expressions
        Values generated by built-in functions
        Dependencies between modules
        Values associated with interpolated values
        Expected variables or outputs marked as sensitive

# Contract Tests
    * answer the question, "Does the expected input to the module match what I think I should pass to it?"
    * check that a configuration using a Terraform module passes properly formatted inputs.
    * Contract tests ensure that the contract between a Terraform configuration’s expected inputs to a module and the module’s actual inputs has not been broken.
    * state testing

# Integration Tests
    * answer the question, "Does this module or configuration create the resources successfully?"
    * use integration tests to verify that Terraform outputs include the correct values or number of resources.
    * frameworks - Terratest or kitchen-terraform

# End-to-End Tests
    * answer the question, "Can someone use the infrastructure system successfully?"
    * End-to-end tests can verify that changes did not break expected functionality.
    * Frameworks like Terratest and kitchen-terraform can also be used for end-to-end tests. 


# Conftest
    * Conftest is a utility to help you write tests against structured configuration data.
    * For instance, you could write tests for your Kubernetes configurations, Tekton pipeline definitions, Terraform code, Serverless configs or any other structured data.
    * Conftest relies on the Rego language from Open Policy Agent for writing policies. 

# Run conf test
    1. Added conftest.exe from https://github.com/open-policy-agent/conftest/releases into the path 
    2. Run the command 
        conftest.exe test main.tf

        conftest test -p policy/sg.rego sg.tf